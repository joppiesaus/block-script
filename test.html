<!DOCTYPE html>
<html>
	<head>
		<title>fractal noise test</title>
		<script src="js/lib/three.min.js"></script>
		<script src="js/lib/perlin.js"></script>
		<script src="js/lib/threejs/libs/stats.min.js"></script>
		<script src="js/lib/threejs/controls/OrbitControls.js"></script>
		<script src="js/lib/threejs/libs/dat.gui.min.js"></script>

		<style type="text/css">
			body{
				margin: 0px;
				overflow: hidden;
			}
			#container{
				width: 100%;
				height: 100%;
			}
		</style>
	</head>
	<body>
		<div id="container">
			
		</div>
		<script type="text/javascript">
			var width = window.innerWidth;
			var height = window.innerHeight;
			var camera, controls, scene, renderer, stats, ground;
			var noise = new Noise(0);
			var settings = {
				fractal: 6,
				quality: 10,
				increase: 2,
				scale: 1,
				size: 300,
				update: function(){
					updateGround();
				}
			}

			function init(){
				//renderer
				renderer = new THREE.WebGLRenderer( { antialias: false } );
				renderer.setClearColor(0xffffff,1)
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );

				container = document.getElementById( 'container' );
				container.appendChild( renderer.domElement );

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				stats.domElement.style.zIndex = 100;
				container.appendChild( stats.domElement );

				//scene
				scene = new THREE.Scene();

				//camera
				camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 20000);
				camera.position.z = 200;
				controls = new THREE.OrbitControls( camera, document.getElementById( 'container' ) );
				controls.damping = 0.2;

				// lights
				light = new THREE.DirectionalLight( 0xffffff );
				light.position.set( 1, 1, 1 );
				scene.add( light );

				//ground
				var geo = new THREE.Geometry();
				var mat = new THREE.MeshNormalMaterial();
				ground = new THREE.Mesh(geo,mat);

				scene.add(ground);
			}
			function initGUI() {

				var gui = new dat.GUI();

				gui.add(settings, 'fractal', 1, 20).step(1);
				gui.add(settings, 'quality', 1, 100).step(1);
				gui.add(settings, 'increase', 1.1, 20);
				gui.add(settings, 'size').step(1);
				gui.add(settings, 'scale', 0.1, 1);
				gui.add(settings, 'update');
			}

			//map
			var points = {};
			function updateGround(){
				ground.geometry.dispose();
				ground.geometry = new THREE.Geometry();
				var geo = ground.geometry;

				//points
				geo.vertices = [];
				points = {};
				for (var x = 0; x < settings.size; x++) {
					for (var y = 0; y < settings.size; y++) {
						var height = 0, q = settings.quality;
						for (var k = 0; k < settings.fractal; k++) {
							height += noise.simplex2(x / q, y / q) * Math.sqrt(q);
							// height += noise.simplex3(x / q, y / q, i) * Math.pow(q, 1/settings.fractal);

							q *= settings.increase;
						};

						//create the point
						if(points[x+'|'+y] == undefined){
							points[x+'|'+y] = geo.vertices.length;
							geo.vertices.push(new THREE.Vector3(x, height * settings.scale, y));
						}
						else{
							geo.vertices[points[x+'|'+y]].set(x, height * settings.scale, y);
						}
					};
				};

				//faces
				geo.faces = [];
				for (var x = 0; x < settings.size; x++) {
					for (var y = 0; y < settings.size; y++) {
						var b = false;
						var v = [
							points[(x+0)+'|'+(y+0)],
							points[(x+1)+'|'+(y+0)],
							points[(x+0)+'|'+(y+1)],
							points[(x+1)+'|'+(y+1)]
						]
						for(var i in v){
							if(v[i] == undefined){
								b = true;
								break;
							}
						}

						if(!b){
							//create face
							geo.faces.push(new THREE.Face3(v[2],v[1],v[0]));
							geo.faces.push(new THREE.Face3(v[1],v[2],v[3]));
						}
					}
				}

				geo.verticesNeedUpdate = true;
				geo.normalsNeedUpdate = true;
				geo.computeFaceNormals();
				ground.position.set(-settings.size/2,0,-settings.size/2);
			}

			function render(){
				requestAnimationFrame(render);
				renderer.render(scene,camera);
				controls.update();
				stats.update();
			}

			init();
			initGUI();
			updateGround();
			render();
		</script>
	</body>
</html>